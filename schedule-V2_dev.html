<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥è¡Œç¨‹ (DEV - Drag Timeline)</title>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc;
            --slot-height: 40px; /* 15åˆ†é˜çš„é«˜åº¦ï¼Œç¨å¾®åŠ é«˜æ–¹ä¾¿æ‰‹æ©Ÿé»æ“Š */
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; overflow-x: hidden; }
        header { background: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 2000; }
        
        .date-selector { display: flex; overflow-x: auto; padding: 15px; gap: 12px; background: white; border-bottom: 1px solid #eee; position: sticky; top: 60px; z-index: 1999; scrollbar-width: none; }
        .date-box { min-width: 65px; padding: 10px; background: #fff; border: 2px solid #f0f0f0; border-radius: 18px; text-align: center; flex-shrink: 0; cursor: pointer; }
        .date-box.active { border-color: var(--primary); background: #e3f2fd; }

        .timeline-wrapper { display: flex; padding: 20px 10px; position: relative; }
        
        /* å·¦å´æ™‚é–“æ¨™ç±¤ */
        .time-axis { width: 50px; flex-shrink: 0; }
        .axis-label { height: calc(var(--slot-height) * 4); font-size: 11px; color: #bbb; text-align: right; padding-right: 8px; font-weight: bold; }

        /* å³å´ç¶²æ ¼ */
        .drop-zone {
            flex-grow: 1;
            position: relative;
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), /* 15åˆ†ç·š */
                linear-gradient(90deg, transparent, transparent);
            background-size: 100% var(--slot-height);
            border-left: 2px solid #eee;
            min-height: calc(var(--slot-height) * 56); /* 14å°æ™‚ */
        }

        /* è¡Œç¨‹å¡ç‰‡ */
        .event-card {
            position: absolute;
            left: 10px; right: 10px;
            background: white;
            border-radius: 16px;
            padding: 10px 15px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            border-left: 6px solid var(--primary);
            cursor: grab;
            z-index: 100;
            user-select: none;
            touch-action: none; /* é‡è¦ï¼šé˜²æ­¢æ‰‹æ©Ÿç¶²é æ»‘å‹•å¹²æ“¾æ‹–æ‹½ */
        }
        .event-card:active { cursor: grabbing; opacity: 0.9; transform: scale(0.98); }
        .event-card h4 { margin: 0 0 5px; font-size: 16px; color: #333; }
        .event-card .card-info { font-size: 12px; color: #888; white-space: pre-wrap; }
        .card-time-badge { font-size: 11px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 4px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { width: 85%; max-width: 350px; background: white; border-radius: 28px; padding: 25px; }
        .modal input, .modal textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; }
        
        .save-hint { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 12px; display: none; z-index: 4000; }
    </style>
</head>
<body>

<header>
    <div class="back-btn" onclick="location.href='index.html'"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
    <b style="font-size: 18px;">ğŸ“… è¡Œç¨‹æ™‚é–“è»¸ (é–‹ç™¼ç‰ˆ)</b>
</header>

<div class="date-selector" id="dateSelector"></div>

<div class="timeline-wrapper">
    <div class="time-axis" id="timeAxis"></div>
    <div class="drop-zone" id="dropZone">
        </div>
</div>

<div id="saveHint" class="save-hint">âœ¨ åµæ¸¬åˆ°ä½ç½®æ›´å‹•ï¼Œå·²è‡ªå‹•åŒæ­¥é›²ç«¯...</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <h2 style="margin: 0 0 15px; font-size: 18px;">ç·¨è¼¯è©³æƒ…</h2>
        <input type="text" id="fTitle" placeholder="è¡Œç¨‹æ¨™é¡Œ">
        <textarea id="fContent" rows="4" placeholder="è¡Œç¨‹å…§å®¹..."></textarea>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="closeModal()" style="flex:1; padding:12px; border:none; border-radius:12px;">å–æ¶ˆ</button>
            <button onclick="saveModal()" style="flex:1; padding:12px; border:none; border-radius:12px; background:var(--primary); color:white;">å„²å­˜</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@interactjs/interactjs/index.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz7lrfOtPmZH7fqUwbiRk3KgHAwZATgi51VSt2YqFamEinhdaxRvzqpMSrtUq7PsAK0bQ/exec";
    const START_H = 8;
    const END_H = 22;
    const SLOT_PX = 40; // 15åˆ†é˜ = 40px
    let allData = [];
    let currentDay = "2026/03/01";
    let editingItem = null;

    // åˆå§‹åŒ–æ™‚é–“è»¸æ¨™ç±¤
    function initAxis() {
        const axis = document.getElementById('timeAxis');
        for (let h = START_H; h <= END_H; h++) {
            const label = document.createElement('div');
            label.className = 'axis-label';
            label.innerText = `${h}:00`;
            axis.appendChild(label);
        }
    }

    async function loadData() {
        const resp = await fetch(GAS_URL + "?type=schedule");
        allData = await resp.json();
        renderDates();
        renderCards();
    }

    function renderDates() {
        const dates = [
            {d: "2026/03/01", label: "3/1", icon: "â„ï¸"}, {d: "2026/03/02", label: "3/2", icon: "â„ï¸"},
            {d: "2026/03/03", label: "3/3", icon: "â„ï¸"}, {d: "2026/03/04", label: "3/4", icon: "ğŸ£"},
            {d: "2026/03/05", label: "3/5", icon: "ğŸ›ï¸"}, {d: "2026/03/06", label: "3/6", icon: "âœˆï¸"}
        ];
        document.getElementById('dateSelector').innerHTML = dates.map(i => `
            <div class="date-box ${currentDay === i.d ? 'active' : ''}" onclick="setDay('${i.d}')">
                <div style="font-size:20px;">${i.icon}</div>
                <div style="font-weight:bold; font-size:12px;">${i.label}</div>
            </div>`).join('');
    }

    function setDay(d) { currentDay = d; renderDates(); renderCards(); }

    function renderCards() {
        const zone = document.getElementById('dropZone');
        zone.querySelectorAll('.event-card').forEach(c => c.remove());

        const filtered = allData.filter(item => item.æ—¥æœŸ && item.æ—¥æœŸ.replace(/-/g, '/') === currentDay);

        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'event-card';
            
            // è¨ˆç®—ä½ç½®
            const [h, m] = item.æ™‚é–“.split(':').map(Number);
            const top = ((h - START_H) * 60 + m) / 15 * SLOT_PX;
            
            card.style.top = top + "px";
            card.innerHTML = `
                <span class="card-time-badge">ğŸ•™ ${item.æ™‚é–“}</span>
                <h4>${item.æ¨™é¡Œ}</h4>
                <div class="card-info">${item.å…§å®¹}</div>
            `;

            // é›™æ“Šé–‹å•Ÿç·¨è¼¯
            card.ondblclick = () => openEdit(item);
            
            zone.appendChild(card);
            setupDrag(card, item);
        });
    }

    // ä½¿ç”¨ Interact.js è™•ç†æ‹–æ‹½å°é½Š
    function setupDrag(el, item) {
        interact(el).draggable({
            listeners: {
                move(event) {
                    const target = event.target;
                    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                    target.style.transform = `translateY(${y}px)`;
                    target.setAttribute('data-y', y);
                },
                end(event) {
                    const target = event.target;
                    const finalY = (parseFloat(target.getAttribute('data-y')) || 0);
                    const originalTop = parseFloat(target.style.top);
                    const currentTop = originalTop + finalY;

                    // å°é½Šåˆ°æœ€è¿‘çš„ 15 åˆ†é˜ (SLOT_PX)
                    const snappedTop = Math.round(currentTop / SLOT_PX) * SLOT_PX;
                    
                    // è¨ˆç®—æ–°æ™‚é–“
                    const totalMins = (snappedTop / SLOT_PX) * 15;
                    const newH = Math.floor(totalMins / 60) + START_H;
                    const newM = totalMins % 60;
                    const newTime = `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;

                    // æ›´æ–° UI ä¸¦åŒæ­¥
                    target.style.top = snappedTop + "px";
                    target.style.transform = 'none';
                    target.setAttribute('data-y', 0);
                    
                    if (newTime !== item.æ™‚é–“) {
                        updateTimeOnCloud(item, newTime);
                    }
                }
            },
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ]
        });
    }

    async function updateTimeOnCloud(item, newTime) {
        document.getElementById('saveHint').style.display = 'block';
        const payload = {
            action: "edit",
            date: currentDay,
            oldTime: item.æ™‚é–“,
            oldTitle: item.æ¨™é¡Œ,
            time: newTime,
            title: item.æ¨™é¡Œ,
            content: item.å…§å®¹,
            keyword: item["Google map keyword"] || ""
        };
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        setTimeout(() => {
            document.getElementById('saveHint').style.display = 'none';
            loadData(); // é‡æ–°æ•´ç†è³‡æ–™
        }, 1500);
    }

    function openEdit(item) {
        editingItem = item;
        document.getElementById('fTitle').value = item.æ¨™é¡Œ;
        document.getElementById('fContent').value = item.å…§å®¹;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    async function saveModal() {
        const payload = {
            action: "edit",
            date: currentDay,
            oldTime: editingItem.æ™‚é–“,
            oldTitle: editingItem.æ¨™é¡Œ,
            time: editingItem.æ™‚é–“,
            title: document.getElementById('fTitle').value,
            content: document.getElementById('fContent').value,
            keyword: editingItem["Google map keyword"] || ""
        };
        closeModal();
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        setTimeout(() => loadData(), 1000);
    }

    initAxis();
    loadData();
</script>
</body>
</html>
