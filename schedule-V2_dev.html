<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥è¡Œç¨‹ (DEV - Sortable)</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc;
            --collapsed-h: 20px;
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 30px; }
        header { background: white; padding: 12px 20px; display: flex; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 2000; }
        
        .date-selector { display: flex; overflow-x: auto; padding: 10px; gap: 8px; background: white; sticky; top: 50px; z-index: 1999; scrollbar-width: none; }
        .date-box { min-width: 50px; padding: 6px; background: #fff; border: 1px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; font-size: 12px; }
        .date-box.active { background: var(--primary); color: white; }

        .timeline-container { display: flex; padding: 10px 0; }
        
        /* å·¦å´æ™‚é–“è»¸ç·š */
        .hour-axis { width: 40px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; color: #ccc; font-size: 11px; }
        .axis-time { height: auto; margin-bottom: 20px; font-weight: bold; }
        .axis-line { width: 2px; flex-grow: 1; background: #eee; margin-bottom: 10px; position: relative; }
        .axis-line::after { content: 'â€¢â€¢â€¢'; position: absolute; top: 50%; left: -8px; writing-mode: vertical-lr; color: #ddd; letter-spacing: 2px; }

        /* è¡Œç¨‹å®¹å™¨ */
        .drop-zone { flex-grow: 1; margin-right: 15px; }

        /* åˆ—è¡¨æ’åºå‹•ç•« */
        .sortable-ghost { opacity: 0.4; background: #e3f2fd !important; }
        .sortable-drag { opacity: 0.9; transform: rotate(2deg); }

        .event-card {
            background: white; border-radius: 16px; padding: 15px;
            margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.04);
            border-left: 6px solid var(--primary);
            cursor: grab; position: relative;
        }
        .event-card:active { cursor: grabbing; }
        .event-card h4 { margin: 0; font-size: 16px; color: #333; }
        .event-card p { margin: 6px 0 0; font-size: 13px; color: #777; white-space: pre-wrap; line-height: 1.5; }
        .card-time { font-size: 11px; color: var(--primary); font-weight: 800; display: block; margin-bottom: 5px; }
        
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; display: none; z-index: 3000; }
    </style>
</head>
<body>

<header>
    <div onclick="location.href='index.html'" style="margin-right:10px; cursor:pointer;"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
    <b>ğŸ“… è¡Œç¨‹æ’åº (DEV)</b>
</header>

<div class="date-selector" id="dateSelector"></div>

<div class="timeline-container">
    <div class="hour-axis" id="hourAxis"></div>
    <div class="drop-zone" id="dropZone"></div>
</div>

<div id="toast"></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz7lrfOtPmZH7fqUwbiRk3KgHAwZATgi51VSt2YqFamEinhdaxRvzqpMSrtUq7PsAK0bQ/exec";
    let allData = [], currentDay = "2026/03/01";

    async function loadData() {
        const r = await fetch(GAS_URL + "?type=schedule");
        allData = await r.json();
        renderDates();
        renderTimeline();
    }

    function renderDates() {
        const TRIP_DATES = ["2026/03/01", "2026/03/02", "2026/03/03", "2026/03/04", "2026/03/05", "2026/03/06"];
        document.getElementById('dateSelector').innerHTML = TRIP_DATES.map(d => `
            <div class="date-box ${currentDay === d ? 'active' : ''}" onclick="changeDay('${d}')">${d.split('/')[1]}/${d.split('/')[2]}</div>`).join('');
    }

    function changeDay(d) { currentDay = d; renderDates(); renderTimeline(); }

    function renderTimeline() {
        const zone = document.getElementById('dropZone');
        const axis = document.getElementById('hourAxis');
        zone.innerHTML = ''; axis.innerHTML = '';

        const dayData = allData.filter(item => (item.æ—¥æœŸ || "").replace(/-/g, '/') === currentDay)
                               .sort((a,b) => a.æ™‚é–“.localeCompare(b.æ™‚é–“));

        dayData.forEach((item, index) => {
            // ç”Ÿæˆå¡ç‰‡
            const card = document.createElement('div');
            card.className = 'event-card';
            card.dataset.title = item.æ¨™é¡Œ; // ç”¨æ–¼æ’åºè­˜åˆ¥
            card.dataset.time = item.æ™‚é–“;
            card.innerHTML = `
                <span class="card-time">ğŸ•™ ${item.æ™‚é–“}</span>
                <h4>${item.æ¨™é¡Œ}</h4>
                <p>${item.å…§å®¹ || ''}</p>
            `;
            zone.appendChild(card);

            // ç”Ÿæˆå·¦å´å°æ™‚å°é½Šæ¨™è¨˜
            const timeLabel = document.createElement('div');
            timeLabel.className = 'axis-time';
            timeLabel.style.height = (card.offsetHeight) + "px";
            timeLabel.innerText = item.æ™‚é–“.split(':')[0];
            axis.appendChild(timeLabel);

            if (index < dayData.length - 1) {
                const line = document.createElement('div');
                line.className = 'axis-line';
                axis.appendChild(line);
            }
        });

        // åˆå§‹åŒ–æ‹–å‹•æ’åº
        new Sortable(zone, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                recalculateTimes(); // æ‹–å‹•çµæŸå¾Œé‡æ–°è¨ˆç®—æ™‚é–“
            }
        });
    }

    // é‡æ–°è¨ˆç®—æ™‚é–“ä¸¦åŒæ­¥åˆ°é›²ç«¯
    async function recalculateTimes() {
        showToast("â³ æ­£åœ¨é‡æ–°è¦åŠƒæ™‚é–“ä¸¦åŒæ­¥...");
        const cards = document.querySelectorAll('.event-card');
        let baseHour = 8;
        let baseMin = 0;

        for (let i = 0; i < cards.length; i++) {
            const newTime = `${String(baseHour).padStart(2,'0')}:${String(baseMin).padStart(2,'0')}`;
            const title = cards[i].dataset.title;
            const oldTime = cards[i].dataset.time;

            // é€™è£¡æ¨¡æ“¬è‡ªå‹•æ™‚é–“éå¢ï¼šæ¯å€‹è¡Œç¨‹é–“éš” 1 å°æ™‚ï¼Œæ‚¨å¯ä»¥æ ¹æ“šéœ€è¦ä¿®æ”¹é‚è¼¯
            baseHour++; 
            
            // æ‰¾å‡ºåŸå§‹è³‡æ–™é€²è¡Œæ›´æ–°
            const item = allData.find(d => d.æ¨™é¡Œ === title && d.æ™‚é–“ === oldTime);
            if (item) {
                const payload = {
                    action: "edit",
                    date: currentDay,
                    oldTime: item.æ™‚é–“,
                    oldTitle: item.æ¨™é¡Œ,
                    time: newTime, // è‡ªå‹•åˆ†é…çš„æ–°æ™‚é–“
                    title: item.æ¨™é¡Œ,
                    content: item.å…§å®¹,
                    keyword: item["Google map keyword"] || ""
                };
                await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            }
        }
        setTimeout(() => loadData(), 1500);
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    window.onload = loadData;
</script>
</body>
</html>
