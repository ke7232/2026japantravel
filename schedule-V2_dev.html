<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¯æ—¥è¡Œç¨‹ (DEV - Timeline)</title>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc;
            --slot-h: 30px; /* 15åˆ†é˜çš„é«˜åº¦ */
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; touch-action: pan-y; }
        header { background: white; padding: 12px 20px; display: flex; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 2000; }
        
        .date-selector { display: flex; overflow-x: auto; padding: 10px; gap: 8px; background: white; border-bottom: 1px solid #eee; sticky; top: 50px; z-index: 1999; scrollbar-width: none; }
        .date-box { min-width: 55px; padding: 8px; background: #fdfdfd; border: 1px solid #eee; border-radius: 12px; text-align: center; flex-shrink: 0; }
        .date-box.active { background: var(--primary); color: white; border-color: var(--primary); }

        .timeline-container { display: flex; padding: 10px 0; min-height: 100vh; }
        
        /* æ¥µç°¡å·¦å´ï¼šåªé¡¯ç¤ºå°æ™‚ */
        .hour-axis { width: 35px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; color: #bbb; font-size: 11px; }
        .hour-mark { height: calc(var(--slot-h) * 4); display: flex; align-items: flex-start; padding-top: 5px; }

        /* è¡Œç¨‹æ”¾ç½®å€ */
        .drop-zone {
            flex-grow: 1;
            position: relative;
            background-image: linear-gradient(#eee 1px, transparent 1px);
            background-size: 100% var(--slot-h); /* 15åˆ†é˜ä¸€æ¢ç·š */
            margin-right: 15px;
            border-left: 1px solid #eee;
        }

        .event-card {
            position: absolute;
            left: 5px; right: 0;
            background: white;
            border-radius: 10px;
            padding: 8px 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            z-index: 100;
            overflow: hidden;
            touch-action: none; /* é˜²æ­¢æ‹–æ‹½æ™‚é é¢æ»¾å‹• */
        }
        .event-card h4 { margin: 0; font-size: 15px; color: #333; }
        .event-card p { margin: 4px 0 0; font-size: 12px; color: #888; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-time { font-size: 10px; color: var(--primary); font-weight: bold; }

        /* å„²å­˜æç¤º */
        #status-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: none; z-index: 3000; }
    </style>
</head>
<body>

<header>
    <div onclick="location.href='index.html'" style="margin-right:10px; cursor:pointer;"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
    <b id="headerTitle">è¼‰å…¥ä¸­...</b>
</header>

<div class="date-selector" id="dateSelector"></div>

<div class="timeline-container">
    <div class="hour-axis" id="hourAxis"></div>
    <div class="drop-zone" id="dropZone"></div>
</div>

<div id="status-toast"></div>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz7lrfOtPmZH7fqUwbiRk3KgHAwZATgi51VSt2YqFamEinhdaxRvzqpMSrtUq7PsAK0bQ/exec";
    const START_H = 8, END_H = 22, SLOT_H = 30;
    let allData = [], currentDay = "2026/03/01";

    // 1. åˆå§‹åŒ–å°æ™‚åº§æ¨™
    function initAxis() {
        const axis = document.getElementById('hourAxis');
        for(let h=START_H; h<=END_H; h++) {
            const div = document.createElement('div');
            div.className = 'hour-mark';
            div.innerText = String(h).padStart(2, '0');
            axis.appendChild(div);
        }
    }

    // 2. è¼‰å…¥è³‡æ–™
    async function loadData() {
        try {
            const r = await fetch(GAS_URL + "?type=schedule");
            allData = await r.json();
            renderDates();
            renderTimeline();
            document.getElementById('headerTitle').innerText = "ğŸ“… æ¯æ—¥è¡Œç¨‹ (DEV)";
        } catch(e) {
            document.getElementById('headerTitle').innerText = "âŒ é€£ç·šå¤±æ•—";
        }
    }

    function renderDates() {
        const TRIP_DATES = [
            {d: "2026/03/01", label: "3/1"}, {d: "2026/03/02", label: "3/2"},
            {d: "2026/03/03", label: "3/3"}, {d: "2026/03/04", label: "3/4"},
            {d: "2026/03/05", label: "3/5"}, {d: "2026/03/06", label: "3/6"}
        ];
        document.getElementById('dateSelector').innerHTML = TRIP_DATES.map(i => `
            <div class="date-box ${currentDay === i.d ? 'active' : ''}" onclick="changeDay('${i.d}')">
                <div style="font-size:12px; font-weight:bold;">${i.label}</div>
            </div>`).join('');
    }

    function changeDay(d) { currentDay = d; renderDates(); renderTimeline(); }

    // 3. æ¸²æŸ“è¡Œç¨‹å¡ç‰‡
    function renderTimeline() {
        const zone = document.getElementById('dropZone');
        zone.innerHTML = ''; // æ¸…ç©º

        // éæ¿¾ä»Šæ—¥è¡Œç¨‹ï¼ˆè™•ç†æ—¥æœŸæ ¼å¼ï¼‰
        const dayData = allData.filter(item => {
            const itemDate = item.æ—¥æœŸ ? item.æ—¥æœŸ.toString().replace(/-/g, '/') : "";
            return itemDate === currentDay;
        });

        dayData.forEach(item => {
            const card = document.createElement('div');
            card.className = 'event-card';
            
            // è¨ˆç®—åˆå§‹ Top ä½ç½®
            const [h, m] = (item.æ™‚é–“ || "08:00").split(':').map(Number);
            const top = ((h - START_H) * 60 + m) / 15 * SLOT_H;
            
            card.style.top = top + "px";
            card.innerHTML = `
                <div class="card-time">${item.æ™‚é–“}</div>
                <h4>${item.æ¨™é¡Œ}</h4>
                <p>${item.å…§å®¹ || ''}</p>
            `;

            zone.appendChild(card);
            makeDraggable(card, item);
        });
    }

    // 4. æ‹–æ‹½åŠŸèƒ½
    function makeDraggable(el, item) {
        interact(el).draggable({
            listeners: {
                move(event) {
                    const target = event.target;
                    const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                    target.style.transform = `translateY(${y}px)`;
                    target.setAttribute('data-y', y);
                },
                end(event) {
                    const target = event.target;
                    const y = parseFloat(target.getAttribute('data-y')) || 0;
                    const oldTop = parseFloat(target.style.top);
                    
                    // å¸é™„åˆ° 15 åˆ†é˜åˆ»åº¦
                    const newTop = Math.round((oldTop + y) / SLOT_H) * SLOT_H;
                    const finalTop = Math.max(0, newTop); 

                    // è¨ˆç®—æ–°æ™‚é–“
                    const totalMins = (finalTop / SLOT_H) * 15;
                    const h = Math.floor(totalMins / 60) + START_H;
                    const m = totalMins % 60;
                    const newTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;

                    // æ›´æ–° UI
                    target.style.top = finalTop + "px";
                    target.style.transform = 'none';
                    target.setAttribute('data-y', 0);
                    target.querySelector('.card-time').innerText = newTime;

                    if(newTime !== item.æ™‚é–“) syncUpdate(item, newTime);
                }
            },
            modifiers: [
                interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })
            ]
        });
    }

    async function syncUpdate(item, newTime) {
        showToast("â³ æ­£åœ¨åŒæ­¥æ™‚é–“...");
        const payload = {
            action: "edit",
            date: currentDay,
            oldTime: item.æ™‚é–“,
            oldTitle: item.æ¨™é¡Œ,
            time: newTime,
            title: item.æ¨™é¡Œ,
            content: item.å…§å®¹,
            keyword: item["Google map keyword"] || ""
        };
        
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        item.æ™‚é–“ = newTime; // æ›´æ–°æœ¬åœ°ç«¯è³‡æ–™
        showToast("âœ… å·²è‡ªå‹•å„²å­˜è‡³é›²ç«¯");
    }

    function showToast(txt) {
        const t = document.getElementById('status-toast');
        t.innerText = txt;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    window.onload = () => {
        initAxis();
        loadData();
    };
</script>
</body>
</html>
