<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¼•äº•æ¾¤ã€‚æ±äº¬</title>
    <style>
        :root { --primary: #5c4ee5; --bg: #f5f6fa; --danger: #ff7675; --slot-h: 32px; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; overflow-x: hidden; scroll-behavior: smooth; }
        
        .top-container { background: var(--primary); padding-bottom: 12px; position: sticky; top: 0; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        header { padding: 20px 20px 8px; display: flex; align-items: center; justify-content: space-between; color: white; }
        .main-title { font-size: 24px; font-weight: 900; letter-spacing: 1px; }
        .version-tag { font-size: 8px; background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 20px; }

        .date-selector { display: flex; overflow-x: auto; padding: 10px 20px; gap: 10px; scrollbar-width: none; }
        .date-box { 
            min-width: 90px; padding: 10px 6px; background: rgba(255,255,255,0.12); 
            border-radius: 10px; text-align: center; color: rgba(255,255,255,0.8); flex-shrink: 0; transition: 0.3s;
        }
        .date-box .day-num { font-size: 11px; display: block; margin-bottom: 2px; font-weight: bold; }
        .date-box .day-id { font-size: 16px; font-weight: 900; }
        .date-box.active { background: white; color: var(--primary); box-shadow: 0 6px 15px rgba(0,0,0,0.15); transform: translateY(-2px); }

        body.edit-mode #dashboardArea { display: none; }
        .dashboard { 
            padding: 18px 22px; background: white; margin: 15px; border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.03); border: 1px solid rgba(92, 78, 229, 0.05);
        }
        .loc-row { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
        .loc-tag { font-size: 11px; background: #f2f3ff; color: var(--primary); padding: 5px 12px; border-radius: 8px; font-weight: 800; letter-spacing: 0.5px; }
        
        .hotel-btn {
            font-size: 10px; background: #ffffff; color: #2e7d32; padding: 4px 10px; border-radius: 20px;
            text-decoration: none; font-weight: bold; border: 1px solid #e8f5e9; display: inline-flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.2s;
        }
        .hotel-btn:active { transform: scale(0.95); background: #f1f8e9; }

        .memo-text { font-size: 15px; color: #2d3436; font-weight: 800; line-height: 1.5; }

        .timeline-container { display: flex; padding: 10px 15px; position: relative; }
        .hour-axis { width: 0; flex-shrink: 0; overflow: hidden; }
        body.edit-mode .hour-axis { width: 45px; border-right: 1px solid #ddd; margin-right: 10px; }
        .axis-label { height: calc(var(--slot-h) * 4); display: flex; align-items: flex-start; justify-content: center; font-size: 12px; color: #888; font-weight: 800; padding-top: 5px; border-bottom: 1px dashed #eee; box-sizing: border-box; }

        .timeline-line { position: absolute; left: 30px; top: 0; bottom: 30px; width: 2px; background: #e0e0e0; z-index: 1; }
        .drop-zone { flex-grow: 1; position: relative; z-index: 2; padding-left: 35px; }
        body.edit-mode .timeline-line { display: none; }
        body.edit-mode .drop-zone { padding-left: 0; background-image: linear-gradient(#e0e0e0 1px, transparent 1px); background-size: 100% var(--slot-h); min-height: 2200px; }

        .event-card { background: white; border-radius: 20px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); display: flex; gap: 15px; align-items: center; position: relative; margin-bottom: 12px; transition: 0.3s; }
        .event-card::before { content: ""; position: absolute; left: -32px; top: 50%; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; border: 3px solid #fff; transform: translateY(-50%); box-shadow: 0 0 0 2px #e0e0e0; }
        body.edit-mode .event-card::before { display: none; }

        .card-content { font-size: 13px; color: #666; margin-top: 8px; line-height: 1.8; white-space: pre-wrap; word-break: break-all; }
        .card-time-block { background: #f8f9fb; border-radius: 12px; min-width: 65px; height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; }
        .time-hm { font-size: 18px; font-weight: 900; color: #333; }
        .card-main { flex-grow: 1; overflow: hidden; }
        .card-title { font-size: 16px; font-weight: 800; color: #2d3436; margin: 0; }

        .map-links-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .map-link { 
            display: inline-flex; align-items: center; gap: 6px; 
            padding: 8px 14px; background: #ffffff; color: #3c4043; 
            border-radius: 12px; font-size: 11px; text-decoration: none; 
            font-weight: 800; border: 1px solid #dadce0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s;
        }

        .event-card.is-current::before { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(92, 78, 229, 0.2), 0 0 20px var(--primary); animation: pulseGlow 1.5s infinite; }
        @keyframes pulseGlow { 0%, 100% { transform: translateY(-50%) scale(1); } 50% { transform: translateY(-50%) scale(1.3); } }

        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: 0.2s; }
        .event-card:hover .card-actions { opacity: 1; }
        .btn-round { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #f2f3ff; color: var(--primary); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .drag-tooltip { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 5px 12px; border-radius: 10px; font-weight: bold; font-size: 14px; display: none; z-index: 5000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .event-card.is-active { transform: scale(1.05); border: 2px solid var(--primary); z-index: 3000; opacity: 1 !important; }
        .event-card.is-active .drag-tooltip { display: block; }
        .unlock-bar-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background: #eee; border-radius: 0 0 20px 20px; display: none; overflow: hidden; }
        .unlock-bar-fill { width: 0%; height: 100%; background: var(--danger); }
        .is-holding .unlock-bar-bg { display: block; }
        .is-holding .unlock-bar-fill { animation: fillProgress 2s linear forwards; }
        @keyframes fillProgress { from { width: 0%; } to { width: 100%; } }

        .add-fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: none; box-shadow: 0 8px 30px rgba(92, 78, 229, 0.4); z-index: 2500; }
        body.edit-mode .add-fab, body.edit-mode .card-actions, body.edit-mode .map-links-container { display: none !important; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { width: 88%; max-width: 360px; background: white; border-radius: 30px; padding: 25px; box-sizing: border-box; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 12px; display: none; z-index: 5000; }
    </style>
</head>
<body onkeydown="if(event.key==='Escape') location.reload()">

<div class="top-container">
    <header>
        <div class="header-title-group">
            <div onclick="location.href='index.html'" style="cursor:pointer;"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="white" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
            <b class="main-title">è¼•äº•æ¾¤ã€‚æ±äº¬</b>
            <span class="version-tag">Ver. 0124-0500</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <span id="cancelBtn" onclick="location.reload()" style="display:none; font-size:12px; cursor:pointer; opacity:0.8; color:white;">å–æ¶ˆèª¿æ•´</span>
            <button id="toggleBtn" onclick="toggleEditMode()" style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); color:white; padding:6px 12px; border-radius:12px; font-size:11px; font-weight:bold;">èª¿æ•´ä½ç½®</button>
        </div>
    </header>
    <div class="date-selector" id="dateSelector"></div>
</div>

<div id="dashboardArea"></div>

<div class="timeline-container">
    <div class="hour-axis" id="hourAxis"></div>
    <div class="timeline-line"></div>
    <div class="drop-zone" id="dropZone"></div>
</div>

<button class="add-fab" onclick="openModal('add')">ï¼‹</button>

<div id="modal-overlay" class="modal-overlay"><div class="modal">
    <h2 id="modalTitle" style="text-align:center; color:var(--primary); margin-top:0;">è¡Œç¨‹ç´°ç¯€</h2>
    <input type="hidden" id="oldDataKey">
    <input type="text" id="fTitle" style="width:100%; padding:14px; margin:10px 0; border:1px solid #eee; border-radius:15px; box-sizing:border-box; background:#f9f9f9;" placeholder="è¡Œç¨‹æ¨™é¡Œ">
    <div style="display:flex; gap:10px; margin:10px 0;">
        <select id="fHour" style="flex:1; padding:12px; border-radius:15px; border:1px solid #eee;"></select>
        <select id="fMin" style="flex:1; padding:12px; border-radius:15px; border:1px solid #eee;"></select>
    </div>
    <textarea id="fContent" rows="4" style="width:100%; padding:14px; border:1px solid #eee; border-radius:15px; margin:8px 0; box-sizing:border-box;" placeholder="å‚™è¨»æ™¯é» (Enterå¯æ‰‹å‹•æ›è¡Œ)..."></textarea>
    <input type="text" id="fKeyword" style="width:100%; padding:14px; border:1px solid #eee; border-radius:15px; margin:8px 0; box-sizing:border-box;" placeholder="åœ°åœ–é—œéµå­— (å¤šå€‹è«‹ç”¨é€—è™Ÿéš”é–‹)">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:15px;">
        <button onclick="closeModal()" style="padding:12px; border-radius:12px; border:none; font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>
        <button style="background:var(--primary); color:white; padding:12px; border-radius:12px; border:none; font-weight:bold; cursor:pointer;" onclick="submitForm()">å„²å­˜</button>
    </div>
</div></div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz7lrfOtPmZH7fqUwbiRk3KgHAwZATgi51VSt2YqFamEinhdaxRvzqpMSrtUq7PsAK0bQ/exec";
    const SLOT_PX = 32; 
    let allData = [], currentDay = "2026/03/01", isEditMode = false;

    // æ›´æ–°é£¯åº—è³‡æ–™
    const dashboardData = {
        "D1": { loc: "è¼•äº•æ¾¤", hotel: "è¼•äº•æ¾¤ç‹å­å¤§é£¯åº—è¥¿é¤¨", memo: "æŠµé”è¼•äº•æ¾¤ï¼Œé–‹å•Ÿé›ªåœ‹ä¹‹æ—…ã€‚" },
        "D2": { loc: "è¼•äº•æ¾¤", hotel: "è¼•äº•æ¾¤ç‹å­å¤§é£¯åº—è¥¿é¤¨", memo: "çŸ³ä¹‹æ•™å ‚è¡Œç¨‹ï¼Œç©¿è‘—ç™¼ç†±è¡£ã€‚" },
        "D3": { loc: "è¼•äº•æ¾¤", hotel: "è¼•äº•æ¾¤ç‹å­å¤§é£¯åº—è¥¿é¤¨", memo: "Outlet è¡€æ‹¼æ—¥ï¼Œæº–å‚™å¥½é«”åŠ›ã€‚" },
        "D4": { isDouble: true, loc1: "è¼•äº•æ¾¤", loc2: "æ±äº¬", hotel: "å”è‰é£¯åº—æ±äº¬ç«™ karaksa hotel TOKYO STATION", memo: "æ­ä¹˜æ–°å¹¹ç·šå‰å¾€æ±äº¬ã€‚" },
        "D5": { loc: "æ±äº¬", hotel: "å”è‰é£¯åº—æ±äº¬ç«™ karaksa hotel TOKYO STATION", memo: "æ„Ÿå—æ±äº¬æ–‡åŒ–é­…åŠ›ã€‚" },
        "D6": { loc: "æ±äº¬", hotel: "å”è‰é£¯åº—æ±äº¬ç«™ karaksa hotel TOKYO STATION", memo: "è¡Œç¨‹æœ€çµ‚æ—¥ï¼Œæœ€å¾Œæ¡è²·ã€‚" }
    };

    const hS = document.getElementById('fHour'), mS = document.getElementById('fMin');
    for(let h=0; h<24; h++) hS.add(new Option(String(h).padStart(2,'0')+'æ™‚', String(h).padStart(2,'0')));
    ['00','15','30','45'].forEach(m => mS.add(new Option(m+'åˆ†', m)));

    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('toggleBtn').innerText = isEditMode ? "å®Œæˆ" : "èª¿æ•´ä½ç½®";
        document.getElementById('cancelBtn').style.display = isEditMode ? "block" : "none";
        document.body.classList.toggle('edit-mode');
        renderTimeline();
    }

    function renderDashboard(dayId) {
        const d = dashboardData[dayId];
        const hotelLink = d.hotel ? `
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.hotel)}" class="hotel-btn" target="_blank">
                ğŸ  ä»Šæ—¥é£¯åº—
            </a>` : "";

        let html = d.isDouble ? 
            `<div class="dashboard">
                <div class="loc-row">
                    <span class="loc-tag">${d.loc1} â†’ ${d.loc2}</span>
                    ${hotelLink}
                </div>
                <div class="memo-text">${d.memo}</div>
            </div>` :
            `<div class="dashboard">
                <div class="loc-row">
                    <span class="loc-tag">${d.loc}</span>
                    ${hotelLink}
                </div>
                <div class="memo-text">${d.memo}</div>
            </div>`;
        document.getElementById('dashboardArea').innerHTML = html;
    }

    async function loadData() {
        const r = await fetch(GAS_URL + "?type=schedule");
        allData = await r.json();
        renderDates(); renderTimeline();
    }

    function renderDates() {
        const dates = ["2026/03/01", "2026/03/02", "2026/03/03", "2026/03/04", "2026/03/05", "2026/03/06"];
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        document.getElementById('dateSelector').innerHTML = dates.map((d, i) => {
            const dateObj = new Date(d);
            const displayDate = `${dateObj.getMonth()+1}/${dateObj.getDate()}${weekdays[dateObj.getDay()]}`;
            return `<div class="date-box ${currentDay === d ? 'active' : ''}" onclick="setDay('${d}', 'D${i+1}')">
                <span class="day-num">${displayDate}</span>
                <span class="day-id">Day${i+1}</span>
            </div>`;
        }).join('');
        renderDashboard(`D${dates.indexOf(currentDay)+1}`);
    }

    function setDay(d, id) { currentDay = d; renderDates(); renderTimeline(); }

    function renderTimeline() {
        const zone = document.getElementById('dropZone'), axis = document.getElementById('hourAxis');
        zone.innerHTML = ''; axis.innerHTML = '';
        document.body.classList.remove('dragging'); interact('.event-card').unset();
        
        if(isEditMode) {
            for(let i=0; i<24; i++) {
                const lbl = document.createElement('div'); lbl.className = 'axis-label';
                lbl.innerText = String(i).padStart(2,'0'); axis.appendChild(lbl);
            }
        }

        const dayData = allData.filter(item => (item.æ—¥æœŸ || "").replace(/-/g, '/') === currentDay).sort((a,b) => a.æ™‚é–“.localeCompare(b.æ™‚é–“));
        const now = new Date(), currentMins = now.getHours() * 60 + now.getMinutes();
        let closestIndex = -1, minDiff = Infinity;

        dayData.forEach((item, index) => {
            const [h, m] = item.æ™‚é–“.split(':').map(Number), itemMins = h * 60 + m, diff = currentMins - itemMins;
            if (diff >= 0 && diff < minDiff) { minDiff = diff; closestIndex = index; }
            
            const keywordsRaw = item["Google map keyword"] || "";
            const keywords = keywordsRaw.split(/[ï¼Œ,ï¼›;]/).map(k => k.trim()).filter(k => k);
            let mapHtml = `<div class="map-links-container">`;
            keywords.forEach(k => {
                mapHtml += `
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(k)}" class="map-link" target="_blank">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#4285F4"/></svg>
                        å‰å¾€ ${k}
                    </a>`;
            });
            mapHtml += `</div>`;

            const safeItem = JSON.stringify(item).replace(/"/g, '"');
            const card = document.createElement('div');
            card.className = `event-card ${index === closestIndex ? 'is-current' : ''}`;
            if(index === closestIndex) card.id = 'active-task';
            card.dataset.originTop = (itemMins / 15) * SLOT_PX;

            card.innerHTML = `
                <div class="drag-tooltip">00:00</div>
                <div class="card-time-block"><span class="time-hm">${item.æ™‚é–“}</span></div>
                <div class="card-main">
                    <h4 class="card-title">${item.æ¨™é¡Œ}</h4>
                    <div class="card-detail">
                        <div class="card-content">${item.å…§å®¹ || ""}</div>
                        ${mapHtml}
                    </div>
                </div>
                <div class="card-actions">
                    <div class="btn-round" onclick='openModal("edit", ${safeItem})'><svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/></svg></div>
                    <div class="btn-round" style="color:var(--danger)" onclick="handleDelete('${item.æ™‚é–“}','${item.æ¨™é¡Œ}')"><svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></div>
                </div>
                <div class="unlock-bar-bg"><div class="unlock-bar-fill"></div></div>`;
            zone.appendChild(card);
            if(isEditMode) {
                card.style.position = 'absolute'; card.style.top = card.dataset.originTop + "px"; card.style.width = "calc(100% - 30px)";
                setupDrag(card, item);
                card.onpointerdown = () => card.classList.add('is-holding');
                card.onpointerup = card.onpointerleave = () => card.classList.remove('is-holding');
            }
        });

        if(!isEditMode) {
            setTimeout(() => {
                const activeEl = document.getElementById('active-task');
                if(activeEl) window.scrollTo({ top: activeEl.getBoundingClientRect().top + window.pageYOffset - 250, behavior: 'smooth' });
            }, 500);
        }
    }

    function setupDrag(el, item) {
        interact(el).draggable({
            hold: 2000, 
            listeners: {
                start(event) { document.body.classList.add('dragging'); event.target.classList.add('is-active'); },
                move(event) {
                    const target = event.target, zoneRect = document.getElementById('dropZone').getBoundingClientRect();
                    let newTop = event.clientY - zoneRect.top; target.style.top = newTop + "px";
                    const totalMins = Math.round(newTop / SLOT_PX) * 15;
                    const hh = Math.floor(totalMins/60), mm = totalMins%60;
                    target.querySelector('.drag-tooltip').innerText = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
                },
                async end(event) {
                    const target = event.target, finalTop = parseFloat(target.style.top);
                    const snappedTop = Math.round(finalTop / SLOT_PX) * SLOT_PX, totalMins = (snappedTop / SLOT_PX) * 15;
                    const newTime = `${String(Math.floor(totalMins/60)).padStart(2,'0')}:${String(totalMins%60).padStart(2,'0')}`;
                    if (newTime !== item.æ™‚é–“ && totalMins < 1440) {
                        showToast(`ğŸš€ åŒæ­¥è‡³ ${newTime}...`);
                        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "edit", date: currentDay, oldTime: item.æ™‚é–“, oldTitle: item.æ¨™é¡Œ, time: newTime, title: item.æ¨™é¡Œ, content: item.å…§å®¹ })});
                        setTimeout(loadData, 1000);
                    } else { renderTimeline(); }
                }
            }
        });
    }

    function openModal(mode, item = null) {
        const isEdit = (mode === 'edit');
        document.getElementById('modalTitle').innerText = isEdit ? "ç·¨è¼¯è¡Œç¨‹" : "æ–°å¢è¡Œç¨‹";
        if (isEdit && item) {
            document.getElementById('fTitle').value = item.æ¨™é¡Œ; document.getElementById('fContent').value = item.å…§å®¹;
            document.getElementById('fKeyword').value = item["Google map keyword"] || "";
            const [h, m] = item.æ™‚é–“.split(':'); document.getElementById('fHour').value = h; document.getElementById('fMin').value = m;
            document.getElementById('oldDataKey').value = JSON.stringify({oldTime: item.æ™‚é–“, oldTitle: item.æ¨™é¡Œ});
        } else {
            document.getElementById('fTitle').value = ""; document.getElementById('fContent').value = "";
            document.getElementById('fKeyword').value = ""; document.getElementById('oldDataKey').value = "";
            document.getElementById('fHour').value = "10"; document.getElementById('fMin').value = "00";
        }
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    async function submitForm() {
        const isEdit = !!document.getElementById('oldDataKey').value;
        const payload = { action: isEdit ? "edit" : "add", date: currentDay, time: `${document.getElementById('fHour').value}:${document.getElementById('fMin').value}`, title: document.getElementById('fTitle').value, content: document.getElementById('fContent').value, keyword: document.getElementById('fKeyword').value };
        if (isEdit) { const old = JSON.parse(document.getElementById('oldDataKey').value); payload.oldTime = old.oldTime; payload.oldTitle = old.oldTitle; }
        closeModal(); showToast("â³ å„²å­˜ä¸­...");
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        setTimeout(loadData, 1200);
    }
    async function handleDelete(time, title) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
        showToast("ğŸ—‘ï¸ åˆªé™¤ä¸­...");
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({action:"delete", date:currentDay, time, title}) });
        setTimeout(loadData, 1200);
    }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    window.onload = loadData;
</script>
</body>
</html>
