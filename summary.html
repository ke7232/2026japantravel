<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³åˆ†æ - 2026 æ—¥æœ¬è¡Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc; --soft: #e3f2fd;
            --accent: #ffcb05; --danger: #ff7675;
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .back-btn { margin-right: 15px; cursor: pointer; }
        
        .container { padding: 20px; max-width: 500px; margin: auto; }

        /* ç¸½é¡å¡ç‰‡é€²åŒ–ç‰ˆ */
        .total-card { 
            background: linear-gradient(135deg, #76c7ff, #5da9e9); color: white; padding: 25px; 
            border-radius: 30px; text-align: center; box-shadow: 0 12px 30px rgba(93,169,233,0.3); 
            margin-bottom: 25px;
        }
        .avg-info {
            background: rgba(255, 255, 255, 0.15); border-radius: 15px;
            padding: 10px; margin-top: 15px; display: flex; justify-content: space-around;
            font-size: 13px;
        }

        .chart-box { 
            background: white; padding: 22px; border-radius: 30px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; 
            text-align: center; border: 1px solid #f0f4f8;
        }
        
        .filter-select {
            width: 100%; padding: 12px; border-radius: 15px; border: 2px solid var(--soft);
            background: #fafafa; font-size: 15px; color: #555; outline: none; margin-bottom: 15px;
            font-weight: bold; -webkit-appearance: none; text-align: center;
        }

        h3 { color: #555; font-size: 15px; margin: 0 0 18px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        #loading-container { padding: 100px 20px; text-align: center; }
        .progress-bar { width: 180px; height: 6px; background: #eee; border-radius: 10px; margin: 15px auto; overflow: hidden; position: relative; }
        .progress-inner { width: 40%; height: 100%; background: var(--primary); border-radius: 10px; position: absolute; animation: loading-move 1.5s infinite ease-in-out; }
        @keyframes loading-move { 0% { left: -40%; } 50% { left: 40%; width: 60%; } 100% { left: 100%; } }
    </style>
</head>
<body>

<header>
    <div class="back-btn" onclick="location.href='index.html'">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>
    <b style="font-size: 18px;">ğŸ“Š æ—…è¡Œæ¶ˆè²»çµ±è¨ˆå ±è¡¨</b>
</header>

<div id="loading-container">
    <div style="font-size: 14px; color: #aaa;">âœ¨ æ­£åœ¨ç”Ÿæˆç²¾ç¾åœ–è¡¨...</div>
    <div class="progress-bar"><div class="progress-inner"></div></div>
</div>

<div class="container" id="main-ui" style="display:none;">
    <div class="total-card">
        <div style="font-size: 13px; opacity: 0.9; letter-spacing: 1px;">å…¨å®¶æ—…ç¨‹ç¸½æ”¯å‡ºä¼°ç®—</div>
        <div id="sumJPY" style="font-size: 38px; font-weight: bold; margin: 5px 0;">Â¥ 0</div>
        <div id="sumTWD" style="font-size: 14px; opacity: 0.8;">ç´„å°å¹£ $0 å…ƒ</div>
        <div class="avg-info">
            <div>ğŸ‘¥ å‡åˆ†(5äºº) <br> <b id="avgJPY">Â¥ 0</b></div>
            <div>ğŸ‡¹ğŸ‡¼ å‡åˆ†(å°å¹£) <br> <b id="avgTWD">$ 0</b></div>
        </div>
    </div>

    <div class="chart-box">
        <h3>ğŸ“ˆ æ¯æ—¥æ¶ˆè²»è¶¨å‹¢ (JPY)</h3>
        <canvas id="trendChart" style="max-height: 200px;"></canvas>
    </div>

    <div class="chart-box">
        <h3>ğŸ‘¤ æˆå“¡ä»£å¢Šæ’å</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="chart-box">
        <h3>ğŸ± æ¶ˆè²»åˆ†é¡åˆ†æ</h3>
        <select class="filter-select" id="userFilter" onchange="updateCatChart()">
            <option value="all">ğŸ“Š æŸ¥çœ‹å…¨é«”æˆå“¡</option>
            <option value="èˆª">ğŸ™‹â€â™‚ï¸ æŸ¥çœ‹ èˆª çš„æ¶ˆè²»</option>
            <option value="å®‰">ğŸ™‹â€â™€ï¸ æŸ¥çœ‹ å®‰ çš„æ¶ˆè²»</option>
            <option value="é¦™">ğŸ™‹â€â™€ï¸ æŸ¥çœ‹ é¦™ çš„æ¶ˆè²»</option>
            <option value="ç‘©">ğŸ™‹â€â™€ï¸ æŸ¥çœ‹ ç‘© çš„æ¶ˆè²»</option>
            <option value="å»·">ğŸ™‹â€â™‚ï¸ æŸ¥çœ‹ å»· çš„æ¶ˆè²»</option>
        </select>
        <canvas id="catChart"></canvas>
        <div id="noDataMsg" style="display:none; color:#ccc; padding:30px;">è©²æˆå“¡ç›®å‰æ²’æœ‰è¨˜å¸³ç´€éŒ„ âœ¨</div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxktADedYUP_K5X8S0aJ-f0XKGjev2qOuNZi1LNN7E5vq1b26KA-71Oc1IZnR1drgYfdg/exec";
    let allExpenses = [];
    let catChartInstance = null;
    let exchangeRate = 0.215;

    async function fetchData() {
        if(localStorage.getItem('isLoggedIn') !== 'true') return location.href='index.html';
        try {
            const [rateRes, dataRes] = await Promise.all([
                fetch('https://open.er-api.com/v6/latest/JPY'),
                fetch(GAS_URL + "?type=history")
            ]);
            const rateData = await rateRes.json();
            exchangeRate = rateData.rates.TWD;
            allExpenses = await dataRes.json();

            processHeaderStats();
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            renderTrendChart();
            renderUserChart();
            updateCatChart();
        } catch(e) { document.getElementById('loading-container').innerHTML = "âŒ è®€å–å¤±æ•—"; }
    }

    function processHeaderStats() {
        let total = allExpenses.reduce((s, r) => s + (parseFloat(r.æ—¥å¹£é‡‘é¡) || 0), 0);
        const twdTotal = Math.round(total * exchangeRate);
        
        document.getElementById('sumJPY').innerText = `Â¥ ${total.toLocaleString()}`;
        document.getElementById('sumTWD').innerText = `ç´„å°å¹£ $${twdTotal.toLocaleString()} å…ƒ (${exchangeRate.toFixed(3)})`;
        document.getElementById('avgJPY').innerText = `Â¥ ${Math.round(total / 5).toLocaleString()}`;
        document.getElementById('avgTWD').innerText = `$ ${Math.round(twdTotal / 5).toLocaleString()}`;
    }

    // æ–°å¢ï¼šè¶¨å‹¢åœ–
    function renderTrendChart() {
        let days = {};
        allExpenses.forEach(row => {
            const date = new Date(row.æ™‚é–“);
            const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
            days[dateStr] = (days[dateStr] || 0) + (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0);
        });

        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: Object.keys(days),
                datasets: [{
                    data: Object.values(days),
                    borderColor: '#76c7ff',
                    backgroundColor: 'rgba(118, 199, 255, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5
                }]
            },
            options: { 
                plugins: { legend: { display: false } },
                scales: { y: { display: false }, x: { grid: { display: false } } }
            }
        });
    }

    function renderUserChart() {
        let userStats = {};
        allExpenses.forEach(row => {
            const name = row.è¨˜éŒ„äºº || "æœªçŸ¥";
            userStats[name] = (userStats[name] || 0) + (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0);
        });

        new Chart(document.getElementById('userChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(userStats),
                datasets: [{
                    data: Object.values(userStats),
                    backgroundColor: ['#76c7ff', '#ffcb05', '#ff9f40', '#4bc0c0', '#9966ff'],
                    borderRadius: 8
                }]
            },
            options: { 
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { 
                    x: { ticks: { display: false }, grid: { display: false }, border: { display: false } },
                    y: { grid: { display: false }, border: { display: false } }
                }
            }
        });
    }

    function updateCatChart() {
        const filterUser = document.getElementById('userFilter').value;
        let catStats = {};
        const filtered = filterUser === 'all' ? allExpenses : allExpenses.filter(row => row.è¨˜éŒ„äºº === filterUser);

        if(filtered.length === 0) {
            document.getElementById('catChart').style.display = 'none';
            document.getElementById('noDataMsg').style.display = 'block';
            return;
        }
        document.getElementById('catChart').style.display = 'block';
        document.getElementById('noDataMsg').style.display = 'none';

        filtered.forEach(row => {
            const cat = row.é¡åˆ¥ || "é›œ";
            catStats[cat] = (catStats[cat] || 0) + (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0);
        });

        if(catChartInstance) catChartInstance.destroy();
        catChartInstance = new Chart(document.getElementById('catChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(catStats),
                datasets: [{
                    data: Object.values(catStats),
                    backgroundColor: ['#ff7675','#74b9ff','#55efc4','#ffeaa7','#a29bfe','#fab1a0'],
                    borderWidth: 6,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                const pct = Math.round((ctx.parsed/total)*100);
                                return ` ${ctx.label}: Â¥${ctx.parsed.toLocaleString()} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    fetchData();
</script>
</body>
</html>
