<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‹äººæ¶ˆè²»åˆ†æ - 2026 æ—¥æœ¬è¡Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc; --soft: #e3f2fd;
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .back-btn { margin-right: 15px; cursor: pointer; }
        
        .container { padding: 20px; max-width: 500px; margin: auto; }

        .total-card { 
            background: linear-gradient(135deg, #76c7ff, #5da9e9); color: white; padding: 30px 20px; 
            border-radius: 30px; text-align: center; box-shadow: 0 12px 30px rgba(93,169,233,0.3); 
            margin-bottom: 25px;
        }

        .chart-box { 
            background: white; padding: 25px; border-radius: 30px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; 
            text-align: center; border: 1px solid #f0f4f8;
        }
        
        /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .filter-select {
            width: 100%; padding: 12px; border-radius: 15px; border: 2px solid var(--soft);
            background: #fafafa; font-size: 16px; color: #555; outline: none; margin-bottom: 20px;
            font-weight: bold; text-align: center;
        }

        h3 { color: #555; font-size: 15px; margin: 0 0 20px; }

        #loading-container { padding: 100px 20px; text-align: center; }
        .progress-bar { width: 200px; height: 8px; background: #eee; border-radius: 10px; margin: 15px auto; overflow: hidden; position: relative; }
        .progress-inner { width: 40%; height: 100%; background: var(--primary); border-radius: 10px; position: absolute; animation: loading-move 1.5s infinite ease-in-out; }
        @keyframes loading-move { 0% { left: -40%; } 50% { left: 40%; width: 60%; } 100% { left: 100%; } }
    </style>
</head>
<body>

<header>
    <div class="back-btn" onclick="location.href='index.html'">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>
    <b style="font-size: 18px;">ğŸ“Š æ¶ˆè²»æ•¸æ“šåˆ†æ</b>
</header>

<div id="loading-container">
    <div style="font-size: 14px; color: #aaa;">âœ¨ æ­£åœ¨åˆ†æå¸³ç›®æ•¸æ“š...</div>
    <div class="progress-bar"><div class="progress-inner"></div></div>
</div>

<div class="container" id="main-ui" style="display:none;">
    <div class="total-card">
        <div style="font-size: 14px; opacity: 0.9;">å…¨å®¶ç´¯è¨ˆç¸½æ”¯å‡º</div>
        <div id="sumJPY" style="font-size: 38px; font-weight: bold; margin: 5px 0;">Â¥ 0</div>
        <div id="sumTWD" style="font-size: 14px; opacity: 0.8;">ç´„å°å¹£ $0 å…ƒ</div>
    </div>

    <div class="chart-box">
        <h3>ğŸ‘¤ æˆå“¡æ”¯å‡ºæ’å</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="chart-box">
        <h3>ğŸ± æ¶ˆè²»åˆ†é¡åˆ†æ</h3>
        <select class="filter-select" id="userFilter" onchange="updateCatChart()">
            <option value="all">ğŸ“Š å…¨é«”æˆå“¡ä½”æ¯”</option>
            <option value="èˆª">ğŸ™‹â€â™‚ï¸ èˆª çš„æ¶ˆè²»</option>
            <option value="å®‰">ğŸ™‹â€â™€ï¸ å®‰ çš„æ¶ˆè²»</option>
            <option value="é¦™">ğŸ™‹â€â™€ï¸ é¦™ çš„æ¶ˆè²»</option>
            <option value="ç‘©">ğŸ™‹â€â™€ï¸ ç‘© çš„æ¶ˆè²»</option>
            <option value="å»·">ğŸ™‹â€â™‚ï¸ å»· çš„æ¶ˆè²»</option>
        </select>
        <canvas id="catChart"></canvas>
        <div id="noDataMsg" style="display:none; color:#ccc; padding:30px;">è©²æˆå“¡å°šç„¡æ¶ˆè²»è¨˜éŒ„ âœ¨</div>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxktADedYUP_K5X8S0aJ-f0XKGjev2qOuNZi1LNN7E5vq1b26KA-71Oc1IZnR1drgYfdg/exec";
    let allExpenses = [];
    let catChartInstance = null;
    let exchangeRate = 0.215;

    // 1. æŠ“å–æ•¸æ“š
    async function fetchData() {
        if(localStorage.getItem('isLoggedIn') !== 'true') return location.href='index.html';
        
        try {
            // åŒæ™‚æŠ“åŒ¯ç‡èˆ‡è³‡æ–™
            const [rateRes, dataRes] = await Promise.all([
                fetch('https://open.er-api.com/v6/latest/JPY'),
                fetch(GAS_URL + "?type=history")
            ]);
            const rateData = await rateRes.json();
            exchangeRate = rateData.rates.TWD;
            allExpenses = await dataRes.json();

            processGeneralStats();
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            renderUserChart();
            updateCatChart(); // åˆå§‹è¼‰å…¥å…¨é«”ä½”æ¯”
            
        } catch(e) { document.getElementById('loading-container').innerHTML = "âŒ è®€å–å¤±æ•—"; }
    }

    // 2. è™•ç†ç¸½é‡‘é¡èˆ‡æˆå“¡æ•¸æ“š
    function processGeneralStats() {
        let total = 0;
        allExpenses.forEach(row => total += (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0));
        document.getElementById('sumJPY').innerText = `Â¥ ${Math.round(total).toLocaleString()}`;
        document.getElementById('sumTWD').innerText = `ç´„å°å¹£ $${Math.round(total * exchangeRate).toLocaleString()} å…ƒ (${exchangeRate.toFixed(3)})`;
    }

    // 3. æ¸²æŸ“æˆå“¡æ’ååœ–è¡¨ (å›ºå®šä¸è®Š)
    function renderUserChart() {
        let userStats = {};
        allExpenses.forEach(row => {
            const name = row.è¨˜éŒ„äºº || "æœªçŸ¥";
            userStats[name] = (userStats[name] || 0) + (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0);
        });

        new Chart(document.getElementById('userChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(userStats),
                datasets: [{
                    label: 'æ”¯å‡ºé‡‘é¡ (JPY)',
                    data: Object.values(userStats),
                    backgroundColor: '#76c7ff',
                    borderRadius: 10
                }]
            },
            options: { 
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } } }
            }
        });
    }

    // 4. æ›´æ–°åˆ†é¡ä½”æ¯”åœ–è¡¨ (å…·å‚™å€‹äººç¯©é¸åŠŸèƒ½)
    function updateCatChart() {
        const filterUser = document.getElementById('userFilter').value;
        let catStats = {};
        
        // ç¯©é¸è³‡æ–™
        const filtered = filterUser === 'all' 
            ? allExpenses 
            : allExpenses.filter(row => row.è¨˜éŒ„äºº === filterUser);

        if(filtered.length === 0) {
            document.getElementById('catChart').style.display = 'none';
            document.getElementById('noDataMsg').style.display = 'block';
            return;
        } else {
            document.getElementById('catChart').style.display = 'block';
            document.getElementById('noDataMsg').style.display = 'none';
        }

        filtered.forEach(row => {
            const cat = row.é¡åˆ¥ || "é›œ";
            catStats[cat] = (catStats[cat] || 0) + (parseFloat(row.æ—¥å¹£é‡‘é¡) || 0);
        });

        const ctx = document.getElementById('catChart');
        if(catChartInstance) catChartInstance.destroy(); // éŠ·æ¯€èˆŠåœ–è¡¨

        catChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(catStats),
                datasets: [{
                    data: Object.values(catStats),
                    backgroundColor: ['#ff6384','#36a2eb','#cc65fe','#ffce56','#4bc0c0','#a2d2ff'],
                    borderWidth: 5,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 15 } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                let total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = Math.round((ctx.parsed / total) * 100);
                                return ` ${ctx.label}: Â¥${ctx.parsed.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    fetchData();
</script>
</body>
</html>
