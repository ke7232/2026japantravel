<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜å¸³ç¸½è¦½ - 2026 æ—¥æœ¬è¡Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #76c7ff; --bg: #f7f9fc; --soft: #e3f2fd;
            --cat1: #ff6384; --cat2: #36a2eb; --cat3: #cc65fe; --cat4: #ffce56; --cat5: #4bc0c0; --cat6: #a29bfe;
        }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        header { background: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .back-btn { margin-right: 15px; cursor: pointer; }
        
        .container { padding: 20px; max-width: 500px; margin: auto; }

        /* ç¸½é‡‘é¡å¡ç‰‡å„ªåŒ– */
        .total-card { 
            background: linear-gradient(135deg, #76c7ff, #5da9e9); color: white; padding: 35px 20px; 
            border-radius: 30px; text-align: center; box-shadow: 0 12px 30px rgba(93,169,233,0.3); 
            margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .total-card::after { content: 'JPY'; position: absolute; right: -10px; bottom: -10px; font-size: 80px; opacity: 0.1; font-weight: bold; }

        /* åœ–è¡¨å¤–æ¡†å„ªåŒ– */
        .chart-box { 
            background: white; padding: 25px; border-radius: 30px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px; 
            text-align: center; border: 1px solid #f0f4f8;
        }
        h3 { color: #555; font-size: 16px; margin: 0 0 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* é€²åº¦æ¢æ¨£å¼ (åŒè¡Œç¨‹é ) */
        #loading-container { padding: 100px 20px; text-align: center; }
        .progress-bar { width: 200px; height: 8px; background: #eee; border-radius: 10px; margin: 15px auto; overflow: hidden; position: relative; }
        .progress-inner { width: 40%; height: 100%; background: var(--primary); border-radius: 10px; position: absolute; animation: loading-move 1.5s infinite ease-in-out; }
        @keyframes loading-move { 0% { left: -40%; } 50% { left: 40%; width: 60%; } 100% { left: 100%; } }
    </style>
</head>
<body>

<header>
    <div class="back-btn" onclick="location.href='index.html'">
        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>
    <b style="font-size: 18px;">ğŸ“Š æ”¯å‡ºçµ±è¨ˆç¸½è¦½</b>
</header>

<div id="loading-container">
    <div style="font-size: 14px; color: #aaa; font-weight: 500;">âœ¨ æ­£åœ¨è¨ˆç®—æ‰€æœ‰å¸³ç›®...</div>
    <div class="progress-bar"><div class="progress-inner"></div></div>
</div>

<div class="container" id="main-ui" style="display:none;">
    <div class="total-card">
        <div style="font-size: 14px; opacity: 0.9; letter-spacing: 1px;">ç›®å‰å…¨å®¶ç´¯ç©ç¸½æ”¯å‡º</div>
        <div id="sumJPY" style="font-size: 42px; font-weight: bold; margin: 10px 0;">Â¥ 0</div>
        <div id="sumTWD" style="background: rgba(255,255,255,0.2); display: inline-block; padding: 5px 15px; border-radius: 50px; font-size: 14px;">ç´„å°å¹£ $0 å…ƒ</div>
    </div>

    <div class="chart-box">
        <h3>ğŸ‘¤ æˆå“¡æ”¯å‡ºæ’å</h3>
        <canvas id="userChart"></canvas>
    </div>

    <div class="chart-box">
        <h3>ğŸ± æ¶ˆè²»åˆ†é¡ä½”æ¯”</h3>
        <canvas id="catChart"></canvas>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxktADedYUP_K5X8S0aJ-f0XKGjev2qOuNZi1LNN7E5vq1b26KA-71Oc1IZnR1drgYfdg/exec";
    let exchangeRate = 0.215; // é è¨­åŒ¯ç‡

    // 1. å…ˆæŠ“å–å³æ™‚åŒ¯ç‡
    async function getRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/JPY');
            const data = await res.json();
            exchangeRate = data.rates.TWD;
        } catch(e) { console.log("åŒ¯ç‡æŠ“å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼"); }
    }

    // 2. æŠ“å– Sheet è³‡æ–™ä¸¦çµ±è¨ˆ
    async function fetchData() {
        if(localStorage.getItem('isLoggedIn') !== 'true') return location.href='index.html';
        
        await getRate(); // ç­‰å¾…åŒ¯ç‡

        try {
            const resp = await fetch(GAS_URL + "?type=history"); // æ³¨æ„é€™è£¡ type=history éœ€èˆ‡ GAS å°æ‡‰
            const data = await resp.json();
            
            let total = 0, users = {}, cats = {};

            data.forEach(row => {
                const amt = parseFloat(row.æ—¥å¹£é‡‘é¡) || 0; 
                total += amt;
                
                // çµ±è¨ˆæˆå“¡
                const userName = row.è¨˜éŒ„äºº || "æœªçŸ¥";
                users[userName] = (users[userName] || 0) + amt;
                
                // çµ±è¨ˆåˆ†é¡
                const catName = row.é¡åˆ¥ || "é›œ";
                cats[catName] = (cats[catName] || 0) + amt;
            });

            // æ›´æ–°ä»‹é¢
            document.getElementById('sumJPY').innerText = `Â¥ ${Math.round(total).toLocaleString()}`;
            document.getElementById('sumTWD').innerText = `ç´„å°å¹£ $${Math.round(total * exchangeRate).toLocaleString()} å…ƒ (${exchangeRate.toFixed(3)})`;
            
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            // ç¹ªè£½åœ–è¡¨
            renderChart('userChart', users, ['#76c7ff','#ffcb05','#ff9f40','#4bc0c0','#9966ff']);
            renderChart('catChart', cats, ['#ff6384','#36a2eb','#cc65fe','#ffce56','#4bc0c0','#a2d2ff']);
            
        } catch(e) { 
            document.getElementById('loading-container').innerHTML = "âŒ çµ±è¨ˆå¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™æ ¼å¼";
        }
    }

    // 3. Chart.js æ¸²æŸ“å„ªåŒ–
    function renderChart(id, stats, colors) {
        new Chart(document.getElementById(id), {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats),
                datasets: [{
                    data: Object.values(stats),
                    backgroundColor: colors,
                    borderWidth: 5,
                    borderColor: '#ffffff',
                    hoverOffset: 10
                }]
            },
            options: {
                cutout: '65%',
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { 
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed || 0;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = Math.round((value / total) * 100);
                                return `${label}: Â¥${value.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    fetchData();
</script>
</body>
</html>
