<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨å®¶éŠæˆ²æŒ‘æˆ°æ¦œ</title>
    <style>
        :root { --primary: #76c7ff; --bg: #f7f9fc; --accent: #ffcb05; --success: #55efc4; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; text-align: center; }
        header { background: white; padding: 15px 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .back-btn { margin-right: 15px; cursor: pointer; }
        
        /*å¯æ„›ç‰ˆä½¿ç”¨è€…é¸æ“‡ä»‹é¢*/
        #user-selector { 
            position: fixed; inset: 0; background: white; z-index: 5000; 
            display: flex; flex-direction: column; align-items: center; padding: 30px 20px;
            overflow-y: auto;
        }
        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0 40px; width: 100%; max-width: 350px; }
        .user-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; border: none; cursor: pointer; transition: 0.3s;
        }
        .avatar-circle {
            width: 70px; height: 70px; border-radius: 50%; background: #f0faff;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; margin-bottom: 8px; border: 3px solid #e3f2fd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .user-name { font-weight: bold; font-size: 16px; color: #555; }
        .user-btn:active .avatar-circle { transform: scale(0.9); border-color: var(--primary); background: #e3f2fd; }

        /*éŠæˆ²å€åŸŸ*/
        .game-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #fff; margin-bottom: 10px; }
        .game-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 10px; max-width: 400px; margin: auto; }
        .card { aspect-ratio: 1/1; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.4s; transform-style: preserve-3d; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 12px; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .card-front { background: #fff; color: #eee; border: 1px solid #f0f0f0; }
        .card-back { background: #fff; transform: rotateY(180deg); border: 1px solid #f0f0f0; }
        
        .card.matched .card-back { background: #e8fff9; color: var(--success); border-color: var(--success); }
        .card.matched .card-back::after { content: "âœ…"; position: absolute; font-size: 16px; bottom: 4px; right: 4px; }

        /*æ’è¡Œæ¦œæ¨£å¼*/
        #leaderboard { margin: 10px auto; padding: 20px; background: #fff; border-radius: 25px; width: 100%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .rank-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f9f9f9; }
        .rank-num { width: 30px; font-weight: bold; font-style: italic; color: #ccc; font-size: 18px; }
        .rank-name { flex: 1; text-align: left; font-weight: bold; margin-left: 10px; color: #444; }
        .rank-score { font-family: monospace; font-weight: bold; color: var(--primary); }
        
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 6000; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">â³ åŒæ­¥é›²ç«¯æˆç¸¾ä¸­...</div>

<div id="user-selector">
    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ¾</div>
    <h2 style="margin: 0; color: var(--primary);">èª°è¦æŒ‘æˆ°ï¼Ÿ</h2>
    <p style="color: #aaa; font-size: 14px; margin-top: 5px;">é»æ“Šé ­åƒé–‹å§‹éŠæˆ²</p>

    <div class="user-grid">
        <div class="user-btn" onclick="startGame('èŠŠ')"><div class="avatar-circle">ğŸ‘</div><div class="user-name">èŠŠ</div></div>
        <div class="user-btn" onclick="startGame('è¾°')"><div class="avatar-circle">ğŸ¦–</div><div class="user-name">è¾°</div></div>
        <div class="user-btn" onclick="startGame('èˆª')"><div class="avatar-circle">ğŸ·</div><div class="user-name">èˆª</div></div>
        <div class="user-btn" onclick="startGame('å®‰')"><div class="avatar-circle">ğŸ¶</div><div class="user-name">å®‰</div></div>
        <div class="user-btn" onclick="startGame('é¦™')"><div class="avatar-circle">ğŸ®</div><div class="user-name">é¦™</div></div>
        <div class="user-btn" onclick="startGame('ç‘©')"><div class="avatar-circle">ğŸ­</div><div class="user-name">ç‘©</div></div>
        <div class="user-btn" onclick="startGame('å»·')"><div class="avatar-circle">ğŸ¯</div><div class="user-name">å»·</div></div>
    </div>

    <div id="leaderboard">
        <h3 style="font-size: 16px; color: var(--accent); margin-top: 0;">ğŸ‘‘ å®¶æ—è‹±é›„æ¦œ</h3>
        <div id="rank-list"><p style="color:#ccc">é€£ç·šä¸­...</p></div>
    </div>
</div>

<header>
    <div class="back-btn" onclick="location.href='index.html'"><svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="#76c7ff" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></div>
    <b style="font-size: 18px;">ğŸ® è¨˜æ†¶å¤§è€ƒé©—</b>
</header>

<div class="game-header">
    <div style="font-weight:bold;">ç©å®¶: <span id="current-player" style="color:var(--primary);">---</span></div>
    <div style="font-weight:bold;">â±ï¸ <span id="timer">0</span>s</div>
</div>

<div class="game-grid" id="grid"></div>

<button onclick="location.reload()" style="margin: 30px 0; padding: 12px 40px; border-radius: 25px; border: none; background: #f0f0f0; color: #888; font-weight: bold;">æ”¾æ£„/é‡é¸ç©å®¶ ğŸ”„</button>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxktADedYUP_K5X8S0aJ-f0XKGjev2qOuNZi1LNN7E5vq1b26KA-71Oc1IZnR1drgYfdg/exec";
    const emojis = ['ğŸ¿', 'â„ï¸', 'â›„', 'ğŸ£', 'ğŸ—¼', 'ğŸ›ï¸', 'ğŸœ', 'ğŸšƒ'];
    let currentPlayer = "", flippedCards = [], matchedPairs = 0, seconds = 0, timerInterval;

    function startGame(name) {
        currentPlayer = name;
        document.getElementById('current-player').innerText = name;
        document.getElementById('user-selector').style.display = 'none';
        initGrid();
        timerInterval = setInterval(() => { seconds++; document.getElementById('timer').innerText = seconds; }, 1000);
    }

    function initGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
        cards.forEach(emoji => {
            const el = document.createElement('div');
            el.className = 'card';
            el.dataset.emoji = emoji;
            el.innerHTML = `<div class="card-inner"><div class="card-front">?</div><div class="card-back">${emoji}</div></div>`;
            el.onclick = () => {
                if (flippedCards.length === 2 || el.classList.contains('flipped') || el.classList.contains('matched')) return;
                el.classList.add('flipped');
                flippedCards.push(el);
                if (flippedCards.length === 2) checkMatch();
            };
            grid.appendChild(el);
        });
    }

    function checkMatch() {
        const [c1, c2] = flippedCards;
        if (c1.dataset.emoji === c2.dataset.emoji) {
            c1.classList.add('matched'); c2.classList.add('matched');
            matchedPairs++; flippedCards = [];
            if (matchedPairs === emojis.length) win();
        } else {
            setTimeout(() => { c1.classList.remove('flipped'); c2.classList.remove('flipped'); flippedCards = []; }, 800);
        }
    }

    async function win() {
        clearInterval(timerInterval);
        document.getElementById('loading').style.display = 'flex';
        await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "gameScore", player: currentPlayer, score: seconds }) });
        
        setTimeout(() => {
            alert(`ğŸ† ${currentPlayer} å®ŒæˆæŒ‘æˆ°ï¼\nè€—æ™‚ï¼š${seconds} ç§’`);
            location.reload(); 
        }, 1000);
    }

    async function updateLeaderboard() {
        try {
            const resp = await fetch(GAS_URL + "?type=game");
            const rawData = await resp.json();
            let bestScores = {};
            rawData.forEach(row => {
                let name = row[1], score = parseInt(row[2]);
                if (name && !isNaN(score)) {
                    if (!bestScores[name] || score < bestScores[name]) bestScores[name] = score;
                }
            });
            let sorted = Object.entries(bestScores).sort((a, b) => a[1] - b[1]);
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            document.getElementById('rank-list').innerHTML = sorted.map(([name, time], i) => `
                <div class="rank-item">
                    <span class="rank-num">${medals[i] || (i+1)}</span>
                    <span class="rank-name">${name}</span>
                    <span class="rank-score">${time}s</span>
                </div>
            `).join('') || '<div style="color:#eee; padding:20px;">å°šç„¡ç´€éŒ„</div>';
        } catch(e) { 
            document.getElementById('rank-list').innerHTML = "<p style='color:#ff7675'>è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—</p>"; 
        }
    }
    window.onload = updateLeaderboard;
</script>
</body>
</html>
